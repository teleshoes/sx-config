#!/usr/bin/perl
use strict;
use warnings;
use File::Basename qw(basename);

my $IPMAGIC_NAME = "sx";
my $USER = "nemo";

my $SRC_DIR = "$ENV{HOME}/Code/sx/apks-aliendalvik4",
my $DEST_DIR_SD = "/media/sdcard/phone/apks-aliendalvik4";
my $DEST_DIR_HOME = "/home/nemo/apks-aliendalvik4";

my $EXEC = basename $0;

my $USAGE = "Usage:
  $EXEC -h|--help
    show this message


  $EXEC [OPTS] [PREFIX]
    -run apk-name on all local apk files:
      apk-name $SRC_DIR/*.apk
    -copy all apks local to remote:
      $SRC_DIR => $USER\@`$IPMAGIC_NAME`:$DEST_DIR_SD
    -list <APK>s that match <PREFIX> (or all, if not given)
      $SRC_DIR/<PREFIX>*.apk
    -on remote, run: apkd-install-preload <APK> <APK> ..
    -on remote, run: apkd-install <APK> <APK> ..

  OPTS
    --home
      use $DEST_DIR_HOME instead of $DEST_DIR_SD
";

sub run(@);
sub runQuiet(@);

sub main(@){
  my $prefix = undef;
  my $destDir = $DEST_DIR_SD;
  while(@_ > 0){
    my $arg = shift @_;
    if($arg =~ /^(-h|--help)$/){
      print $USAGE;
      exit 0;
    }elsif($arg =~ /^(--home)$/){
      $destDir = $DEST_DIR_HOME;
    }elsif($arg =~ /^[a-zA-Z0-9]/){
      die "$USAGE\nERROR: only one PREFIX allowed\n" if defined $prefix;
      $prefix = $arg;
    }else{
      die "$USAGE\nERROR: unknown arg $arg\n";
    }
  }

  $prefix = "" if not defined $prefix;

  my $host = `ipmagic $IPMAGIC_NAME`;
  chomp $host;
  die "could not find host\n" if $host !~ /\w/;

  print "\n\nrenaming ALL local apk files\n";
  my @apkFiles = glob "$SRC_DIR/*.apk";
  for my $apkFile(@apkFiles){
    runQuiet "apk-name", $apkFile;
    if($? != 0){
      die "ERROR: apk-name failed for $apkFile\n";
    }
  }

  print "\n\ncopying ALL apk files local => remote\n";
  run "rsync", "-avP", "--del", "$SRC_DIR/", "$USER\@$host:$destDir/";

  my @baseApkFiles = map {/(^.*\/)?([^\/]+)/; $2} @apkFiles;
  my @filteredApkFiles = grep {/^$prefix/} @baseApkFiles;
  my @destApkFiles = map {"$destDir/$_"} @filteredApkFiles;

  print "\n\ninstalling apk files remotely\n";
  run "ipmagic", $IPMAGIC_NAME, "-u", "root",
    "echo", "apkd-install-preload", @destApkFiles;
  print "\n";
  run "ipmagic", $IPMAGIC_NAME,
    "apkd-install", @destApkFiles;

  print "\n\nignore the installation UIs\n";
  print "just watch each app install on its own in order, and then close the UIs\n";
}

sub run(@){
  print "@_\n";
  system @_;
}
sub runQuiet(@){
  system @_;
}

&main(@ARGV);
