#!/usr/bin/perl
use strict;
use warnings;

sub msg($);

my $LOG_CMD = "sudo journalctl -f | grep -i 'dalvik\\|android'";

my $TIMEOUT_S = 60;

my $USAGE = "Usage:
  $0
    restart aliendalvik
      -fork and run: $LOG_CMD
      -run: ad --restart && ad --wait $TIMEOUT_S
      -kill log reading child
";

sub main(@){
  die "$USAGE\n" if @_ > 0;

  my $pid = fork();
  if($pid){
    msg("adr START");

    system "ad restart";
    system "ad", "--wait", $TIMEOUT_S;
    my $success = $? == 0 ? 1 : 0;

    kill 9, -$pid;
    waitpid $pid, 0;

    if($success){
      msg "adr SUCCESS";
    }else{
      msg "adr TIMEOUT";
    }
  }else{
    setpgrp(0, 0);
    exec $LOG_CMD;
  }
}

sub run(@){
  print "@_\n";
  system @_;
}

sub msg($){
  my ($msg) = @_;
  print "\n\n$msg\n";
  system "udo", "notify", "-t", 2, $msg;
}

&main(@ARGV);
