#!/usr/bin/perl
use strict;
use warnings;

my $targetSize = "1920x1080";

my $localDCIM = "$ENV{HOME}/Code/sx/backup/DCIM";
my $localPixmirror = "$ENV{HOME}/Code/sx/backup/DCIM-pixmirror";

my $remotePixmirror = "/media/sdcard/phone/DCIM-pixmirror";
my $remoteSym = "/home/nemo/pixmirror";

sub run(@);

sub main(@){
  print "making dir remotely\n";
  run "sx", "
    mkdir -p $remotePixmirror
    rm -f $remoteSym
    ln -s $remotePixmirror $remoteSym
  ";

  run "pixmirror", "--size=$targetSize", "--orient", $localDCIM, $localPixmirror;
  die "pixmirror failed\n" if $? != 0;

  my $host = `sx`;
  chomp $host;
  run "rsync", "-avP", "--del",
    "$localPixmirror/",
    "nemo\@$host:$remotePixmirror";
  die "rsync failed\n" if $? != 0;
  run "sx", "symlink-pixmirror";
}

sub run(@){
  print "@_\n";
  system @_;
}

&main(@ARGV);
