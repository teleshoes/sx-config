#!/usr/bin/perl
use strict;
use warnings;
use Time::HiRes qw(time);

my $user = "nemo";
my $ipmagicName = "sx";

my $BASE_DIR = "$ENV{HOME}/Code/sx";
my $BACKUP_HOME_DIR = "$BASE_DIR/backup/backup-home";
my $BACKUP_BASH_HIST_DIR = "$BASE_DIR/backup/backup-bash-history";

my @excludes = qw(
  .cache/org.nemomobile/thumbnails/
  .cache/tracker/
  .cache/qtcmdplayer/

  .local/share/commhistory/
  .local/share/waydroid/

  android_storage/DCIM/OpenCamera

  Pictures/Camera
  Pictures/AdvancedCam
  Pictures/Screenshots
  Videos/Camera
  Videos/AdvancedCam

  Backgrounds/

  Code/
);

sub run(@);
sub nowMillis();

sub main(@){
  my $host = `ipmagic $ipmagicName`;
  chomp $host;

  my $rootUser = "root";

  my @cmd = ("rsync",
    "-avP",
    "--del",
    "--one-file-system",
    "$rootUser\@$host:/home/$user/",
    "$BACKUP_HOME_DIR/",
  );

  for my $exclude(@excludes){
    @cmd = (@cmd, "--exclude=$exclude");
  }

  run @cmd;

  print "\n\n";
  my $nowMillis = nowMillis();
  run "cp", "-ar",
    "$BACKUP_HOME_DIR/.bash_history",
    "$BACKUP_BASH_HIST_DIR/bash-history-$nowMillis";
}

sub run(@){
  print "@_\n";
  system @_;
}

sub nowMillis(){
  return int(time * 1000.0 + 0.5);
}

&main(@ARGV);
