IPMAGIC_NAME="sx"
USER="nemo"
HOST=$(ipmagic $IPMAGIC_NAME)

sshc --close $USER@$HOST
sshc $USER@$HOST echo ok $USER

sshc $USER@$HOST 'su -c "
  sed -i \"s/^\s*#*\s*PermitRootLogin\s.*/PermitRootLogin yes/\" /etc/ssh/sshd_config;
  sed -i \"s/^\s*#*\s*GatewayPorts\s.*/GatewayPorts yes/\" /etc/ssh/sshd_config;
  systemctl restart sshd;
"'

sleep 3

sshc --close root@$HOST
sshc root@$HOST echo ok root

sshc $USER@$HOST "
  set -x
  if [ ! -f ~/.ssh/$HOST.pub ]; then
    ssh-keygen -f ~/.ssh/id_rsa -N '' -t rsa
    mv ~/.ssh/id_rsa.pub ~/.ssh/$HOST.pub
  fi
"

sshc root@$HOST "
  set -x
  mkdir -p /root/.ssh/
"

sshc --scp $USER@$HOST:~/.ssh/$HOST.pub ~/.ssh/$HOST.pub

pubkeys $IPMAGIC_NAME scp
pubkeys $IPMAGIC_NAME-root scp


ipmagic $IPMAGIC_NAME -u $USER touch /home/$USER/.ssh/config
ipmagic $IPMAGIC_NAME -u $USER chmod 655 /home/$USER/.ssh/config

sshc --close $USER@$HOST
sshc --close root@$HOST
